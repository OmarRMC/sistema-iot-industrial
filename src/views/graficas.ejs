<%- include('partials/header') %>

    <div class="max-w-6xl mx-auto px-4 py-10">
        <div class="max-w-6xl mx-auto px-4 py-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">游늵 Gr치ficas en Tiempo Real</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Temperatura -->
                <div class="bg-white rounded-xl border shadow p-4">
                    <h3 class="text-gray-700 font-semibold mb-3">Temperatura</h3>
                    <canvas id="tempChart" height="180"></canvas>
                </div>

                <div class="text-right">
                    <button onclick="exportarExcelPorFecha()"
                        class="inline-flex items-center bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition shadow-sm">
                        <i class="fas fa-file-excel text-white text-lg mr-2"></i>
                        Descargar reporte Excel
                    </button>
                </div>
                <!-- pH -->
                <!-- <div class="bg-white rounded-xl border shadow p-4">
                    <h3 class="text-gray-700 font-semibold mb-3">Corriente</h3>
                    <canvas id="phChart" height="180"></canvas>
                </div> -->
            </div>
        </div>




    </div>

    <!-- Firebase SDK y Chart.js -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        function formatearDecimales(numero, decimales = 2) {
            return parseFloat(numero).toFixed(decimales);
        }
        // Configuraci칩n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB41svdnDLDUDTotvn8N0TVfVeNWgG9ypk",
            authDomain: "base-datos-iot-50cb4.firebaseapp.com",
            databaseURL: "https://base-datos-iot-50cb4-default-rtdb.firebaseio.com",
            projectId: "base-datos-iot-50cb4",
            storageBucket: "base-datos-iot-50cb4.firebasestorage.app",
            messagingSenderId: "522493704609",
            appId: "1:522493704609:web:13686733b75bdb9f7c73e0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Inicializaci칩n de los arrays
        let tempData = [];
        let phData = [];

        // Inicializar gr치ficas
        const tempChart = new Chart(document.getElementById("tempChart"), {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "Temperatura (춿C)",
                    data: [],
                    borderColor: "rgba(255, 99, 132, 1)",
                    backgroundColor: "rgba(255, 99, 132, 0.2)",
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });

        const phChart = new Chart(document.getElementById("phChart"), {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "pH",
                    data: [],
                    borderColor: "rgba(54, 162, 235, 1)",
                    backgroundColor: "rgba(54, 162, 235, 0.2)",
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
            }
        });

        function formatTime(dateIn) {
            if (!dateIn) {
                return null;
            }
            const date = new Date(dateIn);
            const time = date.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            return time;
        }

        // Funci칩n para actualizar los datos y mantener solo los 칰ltimos 10
        function updateChart(chart, dataArray, value, time) {
            const now = time ?? new Date().toLocaleTimeString();
            if (dataArray.length >= 10) {
                dataArray.shift();
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            dataArray.push({ value, now });
            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(formatearDecimales(value));
            chart.update();
        }

        // Escuchar cambios en temperatura
        db.ref("tem").limitToLast(1).on("child_added", (snap) => {
            const value = snap.val();
            const time = formatTime(value.tiempo)
            updateChart(tempChart, tempData, value.tem, time);
        });

        // Escuchar cambios en ph
        db.ref("ph").limitToLast(1).on("child_added", (snap) => {
            const value = snap.val();
            const time = formatTime(value.tiempo)
            updateChart(phChart, phData, value.ph, time);
        });


        db.ref("tem").limitToLast(10).once("value", snap => {
            snap.forEach(child => {
                const value = child.val();
                const time = formatTime(value.tiempo)
                updateChart(tempChart, tempData, value.tem, time);
            });
        })

        db.ref("ph").limitToLast(10).once("value", snap => {
            snap.forEach(child => {
                const value = child.val();
                const time = formatTime(value.tiempo)
                updateChart(phChart, phData, value.ph, time);
            });
        })

        function exportarExcelPorFecha() {

            db.ref("tem").limitToLast(500).once("value", snapshot => {
                const datosFiltrados = [];

                snapshot.forEach(child => {
                    const data = child.val();
                    console.log(data.tem)
                    console.log(data.tiempo)
                    const fecha = new Date(data.tiempo);
                    datosFiltrados.push({
                        Fecha: fecha.toLocaleString(),
                        Temperatura: `${formatearDecimales(data.tem)} 춿C`
                    });
                    // }
                });

                const ws = XLSX.utils.json_to_sheet(datosFiltrados);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Datos Temperatura");


                XLSX.writeFile(wb, "reporte_temperaturas.xlsx");
            });
        }
        // document.getElementById('Filtrar').addEventListener('click', exportarExcelPorFecha);
    </script>
    <%- include('partials/footer') %>